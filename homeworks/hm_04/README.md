# ДЗ_4 Установка и настройка базы данных  ClickHouse и выполнение задания

Часть 1. Подготовка рабочего окружения

1. Подключиться к виртуальной машине.
2. Установить и настроить ZooKeeper.
3. Установить и настроить ClickHouse, выбрав один из доступных вариантов установки:
   – из deb-пакетов (для систем Debian, Ubuntu);
   – из rpm-пакетов (для систем CentOS, RedHat и аналогичных);
   – из tgz-архивов (предкомпилированные бинарные файлы);
   – из Docker-образа (по инструкции с официальной страницы образа ClickHouse Server на Docker Hub);
   – из единого бинарного файла;
   – из исполняемых файлов для нестандартных окружений (например, macOS, FreeBSD, AArch64);
   – из исходного кода (самостоятельная компиляция).
4. Проверить корректность работы кластера ClickHouse совместно с ZooKeeper.

Файлы с инструкциями и скриптами с практикой для выполнения задания

---

Часть 2. Практическое упражнение

Упражнение 1. Запуск и проверка подключения

1. Создать базу данных
2. В созданной базе данных создать таблицу с движком MergeTree.
3. В таблице должно быть не менее четырёх столбцов, при этом необходимо использовать различные типы данных (каждый столбец — своего типа).
4. Заполнить таблицу тестовыми данными (генерацию данных можно выполнить по примеру, приведенному в приложении 1 или по аналогии).
5. Выполнить любой аналитический запрос к созданной таблице, который включает:
   – группировку по одному из столбцов;
   – использование агрегатных функций (например, подсчёт количества уникальных значений и т.п.).
6. Проверить содержимое следующих системных таблиц ClickHouse:
   – system.clusters;
   – system.macros;
   – system.zookeeper;
   – system.distributed_ddl_queue;
   – system.replication_queue;
   – system.trace_log.
7. Проверить работу следующих функций:
   – getMacro (получение значения макроса из конфигурации);
   – clusterAllReplicas (использование функции для распределённых запросов по репликам кластера).
8. С использованием системных таблиц проанализировать и зафиксировать следующие метрики:
   – время выполнения запросов и объём потребляемой памяти;
   – объём дискового пространства, занимаемый таблицей:
      в сжатом виде;
      в несжатом виде;
      объём, занимаемый первичным индексом;
   – объём дискового пространства по каждому столбцу таблицы:
      в сжатом виде;
      в несжатом виде.

Упражнение 2. Размер вставки

8. Провести эксперимент по вставке данных в таблицы с движком MergeTree мелкими и крупными пачками.

9. Создать две таблицы с движком MergeTree.

10. Для второй таблицы создать дополнительную таблицу с движком Buffer, через которую будет выполняться вставка данных.

11. С помощью скрипта запустить одновременную автоматическую вставку записей в обе таблицы.
    Вставка в первую таблицу MergeTree должна выполняться мелкими пачками.  
    Вставка во вторую таблицу MergeTree должна выполняться крупными пачками с использованием буферизации через таблицу с движком Buffer.  

12. При желании можно добавить промежуточные таблицы и материализованные представления, которые будут генерировать случайные данные для вставки.

13. По завершении процесса вставки (в течение 5–10 минут) проверить итоговое количество записей в обеих целевых таблицах.

14. Проверить количество активных и неактивных партиций (кусков данных) в целевых таблицах.
Схема процесса вставки данных.


Упражнение 3. Оптимизация Order by
15. Создать таблицу в соответствии с выданным описанием (см. скрипт в приложении).

16. Заполнить таблицу сгенерированными данными, используя предоставленный скрипт.

17. Выполнить оптимизацию таблицы таким образом, чтобы в результате остался только один кусок (одна партиция).

18. Выполнить указанные запросы (см. приложение) и для каждого запроса:
   – определить среднее время выполнения на серии запусков (не менее 5);
   – зафиксировать количество обработанных строк (параметр PROCESSED, возвращаемый clickhouse-client);
   – проверить объём памяти, занимаемый первичным ключом таблицы.

19. Оптимизировать ORDER BY и PRIMARY KEY таблицы так, чтобы:
   – объём памяти, занимаемый первичным индексом, был минимален;
   – метрики выполнения запросов (время и объём обрабатываемых данных) улучшились.


1. Скрипт создания таблицы.
CREATE TABLE default.person_data (
  id          UInt64,
  region      LowCardinality(String),
  date_birth  Date,
  gender      UInt8,
  is_marital  UInt8,
  dt_create   DateTime default now()
)
ENGINE = MergeTree()
ORDER BY (date_birth);


2. Запрос для заполнения таблицы
INSERT INTO default.person_data(id, region, date_birth, gender, is_marital)
SELECT q.id, q.region, toStartOfDay(q.date_birth) AS date_birth, q.gender, q.is_marital
  FROM (SELECT rand() AS id,
  	   modulo(id, 70) + 20 AS n,
	   toString(n) AS region,
	   floor(randNormal(10000, 1700)) AS k,
	   '1970-01-01' + interval k day AS date_birth,
	   if(modulo(id, 3) = 1, 1, 0) AS gender,
       if((n + k) % 3 = 0 AND date_diff('year', date_birth, now()) > 18, 1, 0) AS is_marital
    FROM numbers(100_000_000)) q;
3. Запрос 1
SELECT t.region,
       countIf(gender = 1 AND date_diff('year', t.date_birth, now()) BETWEEN 20 AND 40) AS cnt_male,
       countIf(gender = 0 AND date_diff('year', t.date_birth, now()) BETWEEN 18 AND 30) AS cnt_female
  FROM default.person_data t
 WHERE t.date_birth BETWEEN toDate('2000-01-01') AND toDate('2000-01-31')
   AND t.region IN ('20', '25', '43', '59')
 GROUP BY t.region; 

4. Запрос 2
SELECT countIf(gender = 1 AND date_diff('year', t.date_birth, now()) BETWEEN 20 AND 40) AS cnt_male,
       countIf(gender = 0 AND date_diff('year', t.date_birth, now()) BETWEEN 18 AND 30) AS cnt_female
  FROM default.person_data t
 WHERE t.is_marital = 1
   AND t.region IN ('80')
 GROUP BY t.region;

Упражнение 4. Сжатие данных

20. На основании таблицы, полученной в результате выполнения задания 2, создать новую таблицу с той же структурой и теми же данными.

22. Подобрать кодеки сжатия для столбцов новой таблицы таким образом, чтобы выполнялись следующие условия:
• общий объём, занимаемый таблицей на диске, уменьшился не менее чем на 25 % по сравнению с исходной таблицей;
• среднее время выполнения обоих рассматриваемых запросов не увеличилось более чем на 10–15 %, при этом желательно, чтобы оно улучшилось.

Дополнительное задание на +1 балл к оценке по дз.
 Продумать и описать дополнительные способы оптимизации структуры таблицы и/или самих запросов с целью ускорения их выполнения.
